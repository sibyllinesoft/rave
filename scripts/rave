#!/bin/bash
# RAVE CLI - Management tool for RAVE development environment
# Usage: rave <command> [options]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
VM_IMAGE="$PROJECT_ROOT/rave-dev.qcow2"

# Shared configuration
if [ -f "${PROJECT_ROOT}/config/rave.env" ]; then
    # shellcheck disable=SC1090
    source "${PROJECT_ROOT}/config/rave.env"
fi

# Functions
print_usage() {
    cat << EOF
üéØ RAVE CLI - Development Environment Manager

USAGE:
    rave <command> [options]

COMMANDS:
    vm start      Start the RAVE development VM
    vm stop       Stop the RAVE development VM  
    vm status     Check VM status
    vm ssh        SSH into the running VM
    vm rebuild    Rebuild the VM from NixOS config

    cert status   Check certificate status
    cert generate Generate new development certificates
    cert fix      Copy/regenerate localhost certs inside VM
    cert real     Obtain real SSL certificates (Let's Encrypt)
    
    health        Check all services health
    vm-monitor    Monitor VM boot (SSH/services/GitLab)
    ready <svc|url> Probe readiness for a service (default: gitlab)
    logs <service> Show logs for a service
    test          Run smoke tests against the VM

EXAMPLES:
    rave vm start
    rave ready gitlab
    rave ready https://localhost:8443/mattermost/
    rave cert real --domain myrave.com --email me@example.com
    rave health
    rave logs traefik

For more help: rave <command> --help
EOF
}

vm_start() {
    echo -e "${BLUE}üöÄ Starting RAVE development VM...${NC}"
    
    if [ ! -f "$VM_IMAGE" ]; then
        echo -e "${RED}‚ùå VM image not found: $VM_IMAGE${NC}"
        echo -e "${YELLOW}üí° Run 'rave vm rebuild' first${NC}"
        exit 1
    fi
    
    # Check if VM is already running
    if pgrep -f "qemu-system.*$VM_IMAGE" > /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  VM appears to already be running${NC}"
        echo -e "${BLUE}üìä VM Status:${NC}"
        vm_status
        return 0
    fi
    
    echo -e "${BLUE}üîß Starting VM with port forwarding...${NC}"
    nohup qemu-system-x86_64 \
        -drive file="$VM_IMAGE",format=qcow2 \
        -m 12G \
        -smp 4 \
        -netdev user,id=net0,hostfwd=tcp::8081-:80,hostfwd=tcp::8889-:8080,hostfwd=tcp::${VM_SSH_PORT:-2224}-:22,hostfwd=tcp::${VM_HTTPS_PORT:-8443}-:443,hostfwd=tcp::${VM_HTTP_PORT:-8888}-:8888 \
        -device virtio-net-pci,netdev=net0 \
        -nographic > /tmp/rave-vm.log 2>&1 &
    
    echo -e "${GREEN}‚úÖ VM started successfully!${NC}"
    echo -e "${BLUE}üì± Access URLs:${NC}"
    echo "  ‚Ä¢ HTTPS (with SSL): https://localhost:${VM_HTTPS_PORT:-8443}/"
    echo "  ‚Ä¢ HTTP (no SSL):    http://localhost:8888/"
    echo "  ‚Ä¢ VM Status:        http://localhost:8889/"
    echo "  ‚Ä¢ SSH Access:       ssh ${VM_USER:-root}@localhost -p ${VM_SSH_PORT:-2224}"
    echo "  ‚Ä¢ NATS Monitor:     https://localhost:${VM_HTTPS_PORT:-8443}/nats/"
    echo ""
    echo -e "${YELLOW}‚è≥ Wait 60+ seconds for all services to initialize${NC}"
}

vm_stop() {
    echo -e "${BLUE}üõë Stopping RAVE development VM...${NC}"
    
    if pkill -f "qemu-system.*$VM_IMAGE"; then
        echo -e "${GREEN}‚úÖ VM stopped successfully${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No running VM found${NC}"
    fi
}

vm_status() {
    echo -e "${BLUE}üìä RAVE VM Status:${NC}"
    
    if pgrep -f "qemu-system.*$VM_IMAGE" > /dev/null; then
        echo -e "${GREEN}‚úÖ VM Process: Running${NC}"
        
        # Test connectivity
        if curl -s -m 5 http://localhost:8889/ > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ VM Network: Accessible${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  VM Network: Starting up or unreachable${NC}"
        fi
        
        # Test services
        if curl -s -m 5 -k "https://localhost:${VM_HTTPS_PORT:-8443}/" > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ HTTPS Service: Running${NC}"
        else
            echo -e "${RED}‚ùå HTTPS Service: Not responding${NC}"
        fi
        
        if curl -s -m 5 http://localhost:8888/ > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ HTTP Service: Running${NC}"
        else
            echo -e "${RED}‚ùå HTTP Service: Not responding${NC}"
        fi
        
    else
        echo -e "${RED}‚ùå VM Process: Not running${NC}"
    fi
}

vm_ssh() {
    echo -e "${BLUE}üîê Connecting to RAVE VM via SSH...${NC}"
    sshpass -p "${VM_PASS:-debug123}" ssh -o "StrictHostKeyChecking=no" "${VM_USER:-root}@${VM_HOST:-localhost}" -p "${VM_SSH_PORT:-2224}" "$@"
}

vm_rebuild() {
    echo -e "${BLUE}üèóÔ∏è  Rebuilding RAVE VM...${NC}"
    cd "$PROJECT_ROOT"
    
    echo -e "${YELLOW}‚ö†Ô∏è  Stopping existing VM...${NC}"
    vm_stop
    
    echo -e "${BLUE}üîß Building new VM image...${NC}"
    if nix build .#development; then
        echo -e "${GREEN}‚úÖ Build successful${NC}"
        
        if [ -f "$VM_IMAGE" ]; then
            echo -e "${YELLOW}üóëÔ∏è  Removing old VM image...${NC}"
            rm "$VM_IMAGE"
        fi
        
        echo -e "${BLUE}üìÅ Copying new VM image...${NC}"
        cp result/nixos.qcow2 "$VM_IMAGE"
        chmod 644 "$VM_IMAGE"
        
        echo -e "${GREEN}‚úÖ VM rebuilt successfully!${NC}"
        echo -e "${YELLOW}üí° Run 'rave vm start' to start the new VM${NC}"
    else
        echo -e "${RED}‚ùå Build failed${NC}"
        exit 1
    fi
}

cert_status() {
    echo -e "${BLUE}üîê Certificate Status:${NC}"
    
    if vm_ssh "test -f /var/lib/acme/rave.local/cert.pem"; then
        echo -e "${GREEN}‚úÖ Development certificates exist${NC}"
        
        # Get certificate info
        CERT_INFO=$(vm_ssh "openssl x509 -in /var/lib/acme/rave.local/cert.pem -noout -dates -subject" 2>/dev/null)
        echo "$CERT_INFO" | while IFS= read -r line; do
            echo "  $line"
        done
    else
        echo -e "${RED}‚ùå No development certificates found${NC}"
        echo -e "${YELLOW}üí° Run 'rave cert generate' to create them${NC}"
    fi
}

cert_generate() {
    echo -e "${BLUE}üîê Generating development certificates...${NC}"
    
    if vm_ssh "systemctl restart generate-dev-certs"; then
        echo -e "${GREEN}‚úÖ Certificates generated successfully${NC}"
        vm_ssh "systemctl restart traefik"
        echo -e "${GREEN}‚úÖ Traefik restarted${NC}"
        cert_status
    else
        echo -e "${RED}‚ùå Certificate generation failed${NC}"
        exit 1
    fi
}

cert_real() {
    local domain=""
    local email=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --domain)
                domain="$2"
                shift 2
                ;;
            --email)
                email="$2"
                shift 2
                ;;
            --help)
                echo "Usage: rave cert real --domain <domain> --email <email>"
                echo ""
                echo "Obtain real SSL certificates using Let's Encrypt"
                echo ""
                echo "Options:"
                echo "  --domain DOMAIN   Domain name for certificate"
                echo "  --email EMAIL     Email for Let's Encrypt registration"
                echo ""
                echo "Example:"
                echo "  rave cert real --domain myrave.com --email admin@myrave.com"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}"
                echo "Run 'rave cert real --help' for usage"
                exit 1
                ;;
        esac
    done
    
    if [ -z "$domain" ] || [ -z "$email" ]; then
        echo -e "${RED}‚ùå Missing required options${NC}"
        echo "Usage: rave cert real --domain <domain> --email <email>"
        exit 1
    fi
    
    echo -e "${BLUE}üåê Obtaining real SSL certificate for: $domain${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  This requires the domain to point to this server${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Port 80 and 443 must be accessible from the internet${NC}"
    
    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled"
        exit 0
    fi
    
    # Update VM configuration to use ACME
    echo -e "${BLUE}üîß Updating VM configuration for ACME...${NC}"
    
    # This would require rebuilding the VM with ACME settings
    echo -e "${YELLOW}üí° To use real certificates:${NC}"
    echo "1. Update infra/nixos/configs/development.nix:"
    echo "   rave.certificates.useACME = true;"
    echo "   rave.certificates.domain = \"$domain\";"
    echo "   rave.certificates.email = \"$email\";"
    echo ""
    echo "2. Rebuild and restart the VM:"
    echo "   rave vm rebuild"
    echo "   rave vm start"
    echo ""
    echo "3. Ensure DNS points $domain to this server's public IP"
    echo "4. Ensure ports 80/443 are accessible from internet"
}

health_check() {
    echo -e "${BLUE}üè• RAVE Health Check${NC}"
    echo ""
    
    # VM Status
    vm_status
    echo ""
    
    # Service Status
    echo -e "${BLUE}üìä Service Status:${NC}"
    SERVICES=("traefik" "redis-default" "redis-gitlab" "postgresql" "nats")
    
    for service in "${SERVICES[@]}"; do
        if vm_ssh "systemctl is-active $service" >/dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ $service: Active${NC}"
        else
            echo -e "${RED}‚ùå $service: Inactive${NC}"
        fi
    done
    
    echo ""
    echo -e "${BLUE}üåê Endpoint Tests:${NC}"
    
    # Test endpoints
    ENDPOINTS=(
        "http://localhost:8889/|VM Status Page"
        "http://localhost:${VM_HTTP_PORT:-8888}/|HTTP (No SSL)" 
        "https://localhost:${VM_HTTPS_PORT:-8443}/|HTTPS (SSL)"
        "https://localhost:${VM_HTTPS_PORT:-8443}/nats/|NATS Monitor"
    )
    
    for endpoint in "${ENDPOINTS[@]}"; do
        IFS='|' read -r url desc <<< "$endpoint"
        if curl -s -m 5 -k "$url" > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ $desc: OK${NC}"
        else
            echo -e "${RED}‚ùå $desc: Failed${NC}"
        fi
    done

    # If detailed health checks exist, run them too
    local hc_dir="${PROJECT_ROOT}/scripts/health_checks"
    if [ -d "$hc_dir" ]; then
        echo ""
        echo -e "${BLUE}ü©∫ Running detailed health checks...${NC}"
        local status=0
        for check_script in "$hc_dir"/*.sh; do
            [ -x "$check_script" ] || continue
            echo "‚Üí $(basename "$check_script")"
            if ! "$check_script"; then
                status=1
            fi
            echo ""
        done
        [ $status -eq 0 ] || return $status
    fi
}

show_logs() {
    local service="${1:-traefik}"
    echo -e "${BLUE}üìú Showing logs for: $service${NC}"
    vm_ssh "journalctl -u $service.service -f"
}

run_tests() {
    echo -e "${BLUE}üß™ Running RAVE smoke tests...${NC}"
    
    # Check if smoke test script exists
    if [ -f "$SCRIPT_DIR/spinup_smoke.sh" ]; then
        echo -e "${BLUE}üîß Running existing smoke test...${NC}"
        "$SCRIPT_DIR/spinup_smoke.sh"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Dedicated smoke test not found, running basic health check${NC}"
        health_check
    fi
}

wait_for() {
    local desc="$1"
    local cmd="$2"
    local max_retries="${MAX_RETRIES:-20}"
    local sleep_interval="${SLEEP_INTERVAL:-15}"
    local attempt=0
    echo -e "${BLUE}‚åõ Waiting for ${desc}${NC}"
    while [ "$attempt" -lt "$max_retries" ]; do
        if eval "$cmd"; then
            return 0
        fi
        attempt=$((attempt + 1))
        echo -n "."
        sleep "$sleep_interval"
    done
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Timeout waiting for ${desc}${NC}"
    return 1
}

monitor_boot() {
    echo -e "${BLUE}üîç Monitoring VM Boot Progress on port ${VM_HTTPS_PORT:-8443}${NC}"
    if wait_for "SSH availability" "vm_ssh true >/dev/null 2>&1"; then
        echo -e "${GREEN}‚úÖ SSH is ready!${NC}"
    else
        exit 1
    fi

    echo -e "${BLUE}üìä Checking internal services...${NC}"
    vm_ssh <<'EOF'
systemctl is-active postgresql.service || echo "Postgres failed"
systemctl is-active redis-main.service || echo "Redis failed"
systemctl is-active gitlab.service || echo "GitLab failed"
systemctl is-active traefik.service || echo "Traefik failed"
EOF

    echo -e "${BLUE}üåê Checking GitLab HTTP response...${NC}"
    response=$(curl -k -s -o /dev/null -w "%{http_code}" "https://localhost:${VM_HTTPS_PORT:-8443}/gitlab/")
    if [[ "$response" =~ ^(200|302)$ ]]; then
        echo -e "${GREEN}üéâ GitLab is ready at https://localhost:${VM_HTTPS_PORT:-8443}/gitlab/${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  GitLab returned HTTP $response. It might still be initializing.${NC}"
    fi
}

ready_service() {
    local target="${1:-gitlab}"
    local max_checks="${MAX_RETRIES:-20}"
    local base_url="https://localhost:${VM_HTTPS_PORT:-8443}"
    local host_candidates=("")

    # Allow full URL as input
    local target_url=""
    local label="$target"
    case "$target" in
        http://*|https://*)
            target_url="$target"
            label="$target"
            ;;
        gitlab)
            target_url="${base_url}/gitlab/"
            host_candidates=("" "auth.localtest.me")
            ;;
        mattermost)
            target_url="${base_url}/mattermost/"
            host_candidates=("" "chat.localtest.me" "auth.localtest.me")
            ;;
        grafana)
            target_url="${base_url}/grafana/"
            host_candidates=("" "auth.localtest.me")
            ;;
        prom*|prometheus)
            target_url="${base_url}/prometheus/"
            host_candidates=("" "auth.localtest.me")
            ;;
        nats)
            target_url="${base_url}/nats/"
            ;;
        *)
            target_url="${base_url}/"
            ;;
    esac

    echo -e "${BLUE}üîç Checking readiness for: ${label}${NC}"
    echo "Time: $(date)"

    local checks=0
    while [ "$checks" -lt "$max_checks" ]; do
        checks=$((checks + 1))
        local success=0
        local last_response="000"
        for host_hdr in "${host_candidates[@]}"; do
            if [ -n "$host_hdr" ]; then
                response=$(curl -k -s -o /dev/null -w "%{http_code}" -H "Host: $host_hdr" "$target_url" 2>/dev/null || echo "000")
            else
                response=$(curl -k -s -o /dev/null -w "%{http_code}" "$target_url" 2>/dev/null || echo "000")
            fi
            last_response="$response"
            case "$response" in
                200|201|202|204|206|301|302|303|307|308|401)
                    success=1
                    break
                    ;;
            esac
        done

        if [ "$success" -eq 1 ]; then
            echo "[$checks/$max_checks] ‚úÖ SUCCESS! ${label} is ready (HTTP ${last_response})"
            echo "üéâ Accessible at: $target_url"
            return 0
        fi

        echo "[$checks/$max_checks] ‚ùì Response: HTTP ${last_response}"
        if [ "$checks" -lt "$max_checks" ]; then
            echo "   Waiting 30 seconds before next check..."
            sleep 30
        fi
    done
    echo "‚ö†Ô∏è  ${label} startup taking longer than expected"
    return 1
}

cert_fix() {
    echo -e "${BLUE}üîß Fixing SSL certificate paths...${NC}"
    if ! vm_ssh true >/dev/null 2>&1; then
        echo -e "${RED}‚ùå Cannot SSH into VM. Ensure VM is running.${NC}"
        exit 1
    fi
    vm_ssh "bash -s" <<'EOF'
mkdir -p /var/lib/acme/localhost
if [ -d /var/lib/acme/rave.local ]; then
    cp -r /var/lib/acme/rave.local/* /var/lib/acme/localhost/
else
    openssl req -x509 -newkey rsa:4096 \
      -keyout /var/lib/acme/localhost/key.pem \
      -out /var/lib/acme/localhost/cert.pem \
      -days 365 -nodes \
      -subj '/CN=localhost'
fi
chown -R traefik:traefik /var/lib/acme/localhost/
chmod 640 /var/lib/acme/localhost/key.pem
chmod 644 /var/lib/acme/localhost/cert.pem
systemctl restart traefik
EOF
    echo -e "${GREEN}‚úÖ Certificates applied and Traefik restarted.${NC}"
}

# Main command parsing
case "${1:-}" in
    ""|"help"|"--help"|"-h")
        print_usage
        ;;
    "vm")
        case "${2:-}" in
            "start")
                vm_start
                ;;
            "stop")
                vm_stop
                ;;
            "status")
                vm_status
                ;;
            "ssh")
                shift 2
                vm_ssh "$@"
                ;;
            "rebuild")
                vm_rebuild
                ;;
            *)
                echo -e "${RED}‚ùå Unknown vm command: ${2:-}${NC}"
                echo "Available: start, stop, status, ssh, rebuild"
                exit 1
                ;;
        esac
        ;;
    "cert")
        case "${2:-}" in
            "status")
                cert_status
                ;;
            "generate")
                cert_generate
                ;;
            "fix")
                cert_fix
                ;;
            "real")
                shift 2
                cert_real "$@"
                ;;
            *)
                echo -e "${RED}‚ùå Unknown cert command: ${2:-}${NC}"
                echo "Available: status, generate, fix, real"
                exit 1
                ;;
        esac
        ;;
    "vm-monitor")
        monitor_boot
        ;;
    ready)
        shift
        service="${1:-gitlab}"
        ready_service "$service"
        ;;
    "health")
        health_check
        ;;
    "logs")
        show_logs "${2:-traefik}"
        ;;
    "test")
        run_tests
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo ""
        print_usage
        exit 1
        ;;
esac
